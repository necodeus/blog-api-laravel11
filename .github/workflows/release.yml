name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: setup php
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, pdo_mysql, xml

      - name: setup composer
        run: |
          php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
          php composer-setup.php --install-dir=/usr/local/bin --filename=composer
          php -r "unlink('composer-setup.php');"

      - name: install
        run: |
          composer install --no-dev --optimize-autoloader

      - name: create release
        id: cr
        run: |
          chmod +x ci/create_release.sh
          ci/./create_release.sh "${{ secrets.PAT }}" "${{ github.repository }}" "${{ github.ref_name }}"
          echo "release_id=$(cat release_id)"
          echo "release_id=$(cat release_id)" >> $GITHUB_OUTPUT

      - name: archive
        env:
          RELEASE_ID: ${{ steps.cr.outputs.release_id }}
        run: |
          cd build
          tar -czf ../blog-api-laravel11-${{ github.ref_name }}.tar.gz * .??*

      - name: upload
        env:
          RELEASE_ID: ${{ steps.cr.outputs.release_id }}
        run: |
          chmod +x ci/upload.sh
          echo "PAT: ${{ secrets.PAT }}"
          echo "REPO: ${{ github.repository }}"
          echo "RELEASE_ID: ${{ env.RELEASE_ID }}"
          echo "VERSION: ${{ github.ref_name }}"
          ci/./upload.sh "${{ secrets.PAT }}" "${{ github.repository }}" "${{ env.RELEASE_ID }}" "${{ github.ref_name }}"
